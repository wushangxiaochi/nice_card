<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge Card Editor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #4a6bff;
            --secondary-color: #ff6b6b;
            --background-color: #f8f9fa;
            --card-background: #ffffff;
            --text-color: #333333;
            --border-radius: 12px;
            --box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .container {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 1200px;
            gap: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .editor-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .editor-section, .preview-section {
            flex: 1;
            min-width: 300px;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            overflow: hidden;
        }

        .editor-section h2, .preview-section h2 {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .form-group {
            margin-bottom: 15px;
            overflow: visible; /* 确保不限制子元素的溢出行为 */
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }

        /* Style tabs */
        .style-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: flex-start; /* 改为左对齐 */
        }

        .style-tab {
            flex: 0 0 calc(33.33% - 10px); /* 改为固定宽度，每行3个 */
            width: calc(33.33% - 10px); /* 确保宽度计算正确 */
            padding: 15px 5px;
            text-align: center;
            background-color: #f5f5f5;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 0.9rem;
            line-height: 1.4;
            min-height: 80px; /* 确保高度统一 */
        }

        .style-tab:hover {
            background-color: #e9ecef;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .style-tab.active {
            border-color: var(--primary-color);
            background-color: rgba(74, 107, 255, 0.1);
            font-weight: bold;
        }

        /* 移除不再需要的图标样式 */
        .style-tab-icon {
            display: none;
        }

        /* 保持工具栏固定 */
        .toolbar {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #f5f5f5;
            border-radius: 6px 6px 0 0;
            margin-bottom: 0;
            border-bottom: 1px solid #ddd;
            padding: 8px;
            display: flex; /* 使用flex布局 */
            justify-content: space-between; /* 均匀分布工具组 */
            align-items: center; /* 垂直居中 */
            flex-wrap: wrap; /* 允许在小屏幕上换行 */
            gap: 8px; /* 组之间的间距 */
        }

        .toolbar button {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toolbar button:hover {
            background-color: #f0f0f0;
        }

        .toolbar button.active {
            background-color: #e6f0ff;
            border-color: #4a6bff;
            color: #4a6bff;
        }

        .toolbar .color-picker, .toolbar .bg-color-picker {
            width: 30px;
            height: 30px;
            padding: 0;
            border: none;
            cursor: pointer;
        }

        .font-size-select {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background-color: white;
        }

        /* 修改编辑器样式，确保滚动条显示 */
        #editor {
            width: 100%;
            min-height: 200px;
            max-height: 300px; /* 减小最大高度，使滚动条更容易出现 */
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            outline: none;
            overflow-y: auto !important; /* 使用!important确保属性不被覆盖 */
            background-color: white;
            display: block; /* 确保元素是块级元素 */
        }

        .preview-card {
            width: 100%;
            max-width: 500px; /* Default max-width */
            min-height: 300px;
            position: relative;
            transition: all 0.3s ease;
            margin: 0 auto; /* Center the card */
        }

        /* Minimalist Style */
        .minimalist {
            background-color: white;
            border: 4px solid #4a6bff; /* 固定蓝色边框 */
            border-radius: 0; /* 方形卡片 */
            padding: 20px;
            box-shadow: var(--box-shadow);
            position: relative; /* 确保能添加顶部装饰 */
        }

        /* 添加极简风格的顶部红色装饰 */
        .minimalist::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background-color: #ff6b6b; /* 红色顶部装饰 */
            z-index: 1;
        }

        /* Enhanced Holographic Style - Updated */
        .holographic {
            background: #314659; /* 修改为固定的深蓝色背景 */
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2),
                0 0 15px rgba(255,255,255,0.1);
            position: relative;
            overflow: hidden;
        }

        .holographic::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, 
                #ff0000, 
                #ff9900, 
                #ffff00, 
                #33cc33, 
                #3399ff, 
                #9933ff, 
                #ff00ff);
            z-index: 1;
        }

        .holographic .card-title {
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        .holographic .card-content {
            background-color: rgba(255, 255, 255, 0.75); /* 更浅、更透明的白色背景 */
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            border: 2px solid #9933ff; /* 保持紫色边框不变 */
        }

        .holographic .card-content::before {
            display: none; /* 移除原有的渐变边框 */
        }

        .holographic .card-watermark {
            color: rgba(255, 255, 255, 0.7);
        }

        .card-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .card-content {
            margin-bottom: 20px;
        }

        /* Image styling in the card content */
        .card-content img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 10px auto;
            border-radius: 6px;
        }

        .card-watermark {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 0.8rem;
            opacity: 0.5;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .editor-container {
                flex-direction: column;
            }
            
            .editor-section, .preview-section {
                width: 100%;
            }

            .style-tab {
                flex: 0 0 calc(50% - 10px); /* 小屏幕上每行2个 */
                width: calc(50% - 10px);
            }
        }

        /* 调整工具组样式 */
        .toolbar-group {
            display: flex;
            gap: 5px;
            align-items: center;
            flex-wrap: nowrap; /* 确保工具组内的按钮不换行 */
        }

        .align-group button {
            width: 36px;
        }

        .file-input {
            display: none;
        }

        .file-label {
            display: inline-block;
            padding: 6px 10px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .file-label:hover {
            background-color: #f0f0f0;
        }

        /* Editor image styling */
        #editor img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 10px auto;
        }

        /* Tooltip for format painter */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 120px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -60px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Preview controls */
        .preview-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .preview-controls button {
            flex: 1;
            padding: 8px 12px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: all 0.2s ease;
        }

        .preview-controls button:hover {
            background-color: #e9ecef;
        }

        .preview-controls button i {
            font-size: 14px;
        }

        .card-size-info {
            text-align: center;
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 10px;
        }

        /* 新波普艺术风格 (Neopop) */
        .neopop {
            background-color: #fff;
            border: 3px solid #000;
            border-radius: 0; /* 方形卡片 */
            padding: 25px;
            position: relative;
            box-shadow: 8px 8px 0 #000;
            transform: translate(-4px, -4px);
            transition: transform 0.2s, box-shadow 0.2s;
            overflow: visible; /* 允许内容溢出边界，以便显示完整圆形 */
        }

        /* 调整棋盘格装饰 - 解决位置和尺寸问题 */
        .neopop .checkerboard-decoration {
            position: absolute;
            top: 0; /* 严格置顶，确保没有白边 */
            left: 0;
            right: 0;
            height: 45px; /* 设定高度为3个方格的高度 */
            display: flex;
            flex-direction: column;
            z-index: 0; /* 降低z-index让标题在上层 */
            overflow: hidden;
        }

        .neopop .checkerboard-row {
            display: flex;
            height: 15px;
        }

        .neopop .checker-square {
            width: 15px;
            height: 15px;
            flex-shrink: 0;
        }

        .neopop .checker-square.pink {
            background-color: #FF61D8;
        }

        .neopop .checker-square.white {
            background-color: white;
        }

        .neopop::after {
            content: "";
            position: absolute;
            bottom: 60px;
            right: 15px;
            width: 20px;
            height: 20px;
            background-color: #4BE3AC; /* 绿色装饰 */
            border-radius: 50%;
            z-index: 3; /* 提高z-index，确保在内容上方 */
        }

        .neopop:hover {
            transform: translate(-8px, -8px);
            box-shadow: 12px 12px 0 #000;
        }

        /* 确保标题在上层 */
        .neopop .card-title {
            position: relative; /* 确保定位上下文 */
            z-index: 2; /* 提高z-index，确保在棋盘格上方 */
            color: #000;
            font-weight: 800;
            margin-bottom: 20px;
            font-size: 1.8rem;
            padding: 5px 10px;
            background-color: #56CCF2; /* 蓝色背景 */
            display: inline-block;
            border: 3px solid #000;
        }

        .neopop .card-content {
            background-color: #FBD348; /* 黄色背景 */
            border: 3px solid #000;
            padding: 20px;
            margin: 20px 0 30px; /* 增加上下边距，为圆形留出空间 */
            box-shadow: 5px 5px 0 #000;
            position: relative;
            z-index: 1;
            overflow: visible; /* 允许圆形突出内容区域 */
        }

        /* 需要通过JavaScript添加网格背景元素 */
        .neopop .grid-background {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(90deg, rgba(0, 0, 0, 0.1) 1px, transparent 1px),
                linear-gradient(rgba(0, 0, 0, 0.1) 1px, transparent 1px);
            background-size: 15px 15px;
            z-index: 0;
            pointer-events: none;
        }

        /* 修改圆形装饰的位置，确保一半在内一半在外 */
        .neopop .card-content::before {
            content: "";
            position: absolute;
            left: 15px;
            top: -15px; /* 向上偏移，使一半在外 */
            width: 30px;
            height: 30px;
            background-color: #ff6b6b;
            border: 3px solid #000;
            border-radius: 50%;
            z-index: 2; /* 确保在网格背景上方 */
        }

        .neopop .card-content::after {
            content: "";
            position: absolute;
            right: 15px;
            bottom: -15px; /* 向下偏移，使一半在外 */
            width: 30px;
            height: 30px;
            background-color: #4a6bff;
            border: 3px solid #000;
            border-radius: 50%;
            z-index: 2; /* 确保在网格背景上方 */
        }

        .neopop .card-watermark {
            color: #555;
            font-weight: bold;
            font-style: italic;
        }

        /* 暗黑科技风格 (Darktech) */
        .darktech {
            background-color: #0a0a0a;
            border: 1px solid #30cfd0;
            border-radius: 8px;
            padding: 25px;
            position: relative;
            box-shadow: 0 0 15px rgba(48, 207, 208, 0.5);
            overflow: hidden;
        }

        .darktech::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                linear-gradient(90deg, #0a0a0a 20px, transparent 1%) center,
                linear-gradient(#0a0a0a 20px, transparent 1%) center,
                rgba(48, 207, 208, 0.1);
            background-size: 22px 22px;
            z-index: 0;
        }

        .darktech .card-title {
            color: #30cfd0;
            font-weight: 600;
            margin-bottom: 25px;
            position: relative;
            text-shadow: 0 0 10px rgba(48, 207, 208, 0.7);
            font-family: 'Courier New', monospace;
            padding-left: 15px;
            border-left: 3px solid #30cfd0;
            z-index: 1;
        }

        .darktech .card-content {
            background-color: rgba(10, 10, 10, 0.8);
            border: 1px solid #30cfd0;
            border-radius: 5px;
            padding: 20px;
            margin: 10px 0 20px;
            color: #ffffff;
            position: relative;
            z-index: 1;
            font-family: 'Courier New', monospace;
            box-shadow: 0 0 10px rgba(48, 207, 208, 0.3);
        }

        .darktech .card-watermark {
            color: #30cfd0;
            font-family: 'Courier New', monospace;
            opacity: 0.5;
        }

        /* 赛博朋克风格 (Cyberpunk) */
        .cyberpunk {
            background: linear-gradient(135deg, #0b0b2a 0%, #1a1a3a 100%);
            color: #00fffc;
            border: none; /* 移除原有边框 */
            border-radius: 5px;
            padding: 25px;
            position: relative;
            overflow: visible; /* 修改为visible允许边框效果溢出 */
        }

        /* 外层发光边框 */
        .cyberpunk::after {
            content: "";
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border: 4px solid rgba(255, 0, 255, 0.5);
            border-radius: 9px;
            filter: blur(3px);
            z-index: 0; /* 修改为0 */
            pointer-events: none;
        }

        /* 内层发光边框 */
        .cyberpunk::before {
            content: "";
            position: absolute;
            top: -1px;
            left: -1px;
            right: -1px;
            bottom: -1px;
            background-image: 
                linear-gradient(rgba(255, 0, 255, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 0, 255, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            border: 2px solid rgba(0, 255, 252, 0.8);
            border-radius: 7px;
            filter: blur(2px);
            z-index: 1; /* 修改为1 */
            pointer-events: none;
        }

        /* 确保内容在最上层 */
        .cyberpunk .card-title,
        .cyberpunk .card-content,
        .cyberpunk .card-watermark,
        .cyberpunk .circuit-lines {
            position: relative;
            z-index: 2; /* 所有内容元素的z-index设为2，确保在边框上方 */
        }

        .cyberpunk .card-title {
            color: #ff00ff;
            text-shadow: 0 0 10px #ff00ff;
            font-family: 'Arial', sans-serif;
            font-weight: 700;
            position: relative;
            z-index: 1;
            border-left: 3px solid #00fffc;
            padding-left: 15px;
            margin-bottom: 25px;
        }

        .cyberpunk .card-content {
            background-color: rgba(10, 10, 43, 0.7);
            border: 1px solid #00fffc;
            border-radius: 5px;
            padding: 20px;
            color: #00fffc;
            text-shadow: 0 0 5px rgba(0, 255, 252, 0.7);
            position: relative;
            z-index: 1;
            box-shadow: 0 0 10px rgba(0, 255, 252, 0.3);
        }

        .cyberpunk .card-watermark {
            color: #ff00ff;
            opacity: 0.7;
            text-shadow: 0 0 5px #ff00ff;
            position: absolute; /* 从relative改为absolute */
            bottom: 10px;
            right: 10px; /* 确保在右下角 */
        }

        .cyberpunk .circuit-lines {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 100px;
            height: 50px;
            border-bottom: 2px solid #00fffc;
            border-left: 2px solid #00fffc;
            z-index: 0;
            opacity: 0.7;
        }

        /* 蒸汽波风格 (Vaporwave) */
        .vaporwave {
            background: linear-gradient(to bottom, #c774e8 0%, #94a6fe 100%);
            color: white;
            border: 4px solid #0ff;
            border-radius: 0;
            box-shadow: 0 0 0 2px #ff71ce, 0 0 25px rgba(0, 255, 255, 0.5);
            position: relative;
            overflow: hidden;
            padding: 25px;
        }

        .vaporwave::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: linear-gradient(90deg, 
                transparent 0%, #0ff 10%, 
                #ff71ce 30%, transparent 40%, 
                #0ff 60%, #ff71ce 80%, 
                transparent 100%);
            z-index: 1;
        }

        .vaporwave::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: linear-gradient(90deg, 
                transparent 0%, #0ff 10%, 
                #ff71ce 30%, transparent 40%, 
                #0ff 60%, #ff71ce 80%, 
                transparent 100%);
            z-index: 1;
        }

        .vaporwave .card-title {
            color: white;
            font-size: 2rem;
            font-weight: bold;
            text-shadow: 3px 3px 0 #ff71ce, 6px 6px 0 #01cdfe;
            letter-spacing: 2px;
            margin-bottom: 25px;
            text-transform: uppercase;
            position: relative;
            z-index: 2;
        }

        .vaporwave .card-content {
            background-color: rgba(255, 255, 255, 0.2);
            border: 2px solid #01cdfe;
            padding: 20px;
            position: relative;
            text-shadow: 1px 1px 0 #01cdfe;
            z-index: 2;
            margin-bottom: 20px;
        }

        .vaporwave .card-watermark {
            color: #fff;
            font-family: 'Arial', sans-serif;
            opacity: 0.7;
            text-shadow: 2px 2px 0 #ff71ce;
            font-style: italic;
            z-index: 2;
            position: absolute;
            bottom: 10px;
            right: 10px;
        }

        .vaporwave .grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            pointer-events: none;
            z-index: 0;
        }

        .vaporwave .digital-time {
            position: absolute;
            top: 15px;
            right: 15px;
            font-family: 'Courier New', monospace;
            font-size: 1rem;
            color: #fff;
            background: rgba(1, 205, 254, 0.2);
            padding: 5px 10px;
            border: 1px solid #01cdfe;
            z-index: 2;
        }

        .vaporwave .card-decoration {
            position: absolute;
            bottom: 60px;
            right: 25px;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff71ce, #ff71ce 50%, #01cdfe 50%, #01cdfe);
            z-index: 1;
            box-shadow: 0 0 15px rgba(1, 205, 254, 0.5);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Knowledge Card Editor</h1>
            <p>Create beautiful, interactive knowledge cards with real-time preview</p>
        </div>

        <div class="editor-container">
            <div class="editor-section">
                <h2>Editor</h2>
                <div class="form-group">
                    <label for="card-title-input">Card Title</label>
                    <input type="text" id="card-title-input" placeholder="Enter card title...">
                </div>

                <div class="form-group">
                    <label>Card Style</label>
                    <div class="style-tabs">
                        <div class="style-tab active" data-style="minimalist">
                            Minimalist<br>极简风格
                        </div>
                        <div class="style-tab" data-style="holographic">
                            Holographic<br>全息风格
                        </div>
                        <div class="style-tab" data-style="neopop">
                            Neopop<br>新波普风格
                        </div>
                        <div class="style-tab" data-style="darktech">
                            Darktech<br>暗黑科技
                        </div>
                        <div class="style-tab" data-style="cyberpunk">
                            Cyberpunk<br>赛博朋克
                        </div>
                        <div class="style-tab" data-style="vaporwave">
                            Vaporwave<br>蒸汽波
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="watermark-input">Watermark</label>
                    <input type="text" id="watermark-input" placeholder="Enter watermark text...">
                </div>

                <div class="form-group">
                    <label>Content</label>
                    <div class="toolbar">
                        <div class="toolbar-group">
                            <button id="bold-btn" title="Bold"><i class="fas fa-bold"></i></button>
                            <button id="italic-btn" title="Italic"><i class="fas fa-italic"></i></button>
                            <button id="underline-btn" title="Underline"><i class="fas fa-underline"></i></button>
                            <button id="clear-format-btn" title="Clear Format"><i class="fas fa-remove-format"></i></button>
                        </div>
                        
                        <div class="toolbar-group">
                            <select id="font-size" class="font-size-select" title="Font size">
                                <option value="1">Small</option>
                                <option value="2" selected>Normal</option>
                                <option value="3">Medium</option>
                                <option value="4">Large</option>
                                <option value="5">X-Large</option>
                                <option value="6">XX-Large</option>
                                <option value="7">XXX-Large</option>
                            </select>
                        </div>
                        
                        <div class="toolbar-group">
                            <input type="color" id="text-color" class="color-picker" title="Text color">
                            <input type="color" id="bg-color" class="bg-color-picker" value="#ffffff" title="Background color">
                        </div>
                        
                        <div class="toolbar-group align-group">
                            <button id="align-left" title="Align left"><i class="fas fa-align-left"></i></button>
                            <button id="align-center" title="Align center"><i class="fas fa-align-center"></i></button>
                            <button id="align-right" title="Align right"><i class="fas fa-align-right"></i></button>
                        </div>
                        
                        <div class="toolbar-group">
                            <div class="tooltip">
                                <button id="format-painter" title="Format Painter"><i class="fas fa-paint-brush"></i></button>
                                <span class="tooltiptext">Click to copy format, then select text to apply</span>
                            </div>
                        </div>
                        
                        <div class="toolbar-group">
                            <input type="file" id="image-upload" class="file-input" accept="image/*">
                            <label for="image-upload" class="file-label" title="Insert image">
                                <i class="fas fa-image"></i>
                            </label>
                        </div>
                    </div>
                    <div id="editor" contenteditable="true"></div>
                </div>
            </div>

            <div class="preview-section">
                <h2>Preview</h2>
                <div class="preview-controls">
                    <button id="narrow-btn" title="Narrow card"><i class="fas fa-compress-alt"></i> Narrow</button>
                    <button id="widen-btn" title="Widen card"><i class="fas fa-expand-alt"></i> Widen</button>
                    <button id="download-btn" title="Download card as image"><i class="fas fa-image"></i> Download</button>
                </div>
                <div class="card-size-info">Card width: <span id="card-width">500</span>px</div>
                <div id="preview-card" class="preview-card minimalist">
                    <div id="card-title" class="card-title">Your Card Title</div>
                    <div id="card-content" class="card-content">Start editing to see your content here...</div>
                    <div id="card-watermark" class="card-watermark">Watermark</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Elements
        const cardTitleInput = document.getElementById('card-title-input');
        const styleTabs = document.querySelectorAll('.style-tab');
        const watermarkInput = document.getElementById('watermark-input');
        const editor = document.getElementById('editor');
        const previewCard = document.getElementById('preview-card');
        const cardTitle = document.getElementById('card-title');
        const cardContent = document.getElementById('card-content');
        const cardWatermark = document.getElementById('card-watermark');
        const cardWidthDisplay = document.getElementById('card-width');
        
        // Toolbar buttons
        const boldBtn = document.getElementById('bold-btn');
        const italicBtn = document.getElementById('italic-btn');
        const underlineBtn = document.getElementById('underline-btn');
        const fontSizeSelect = document.getElementById('font-size');
        const textColor = document.getElementById('text-color');
        const bgColor = document.getElementById('bg-color');
        const alignLeft = document.getElementById('align-left');
        const alignCenter = document.getElementById('align-center');
        const alignRight = document.getElementById('align-right');
        const formatPainter = document.getElementById('format-painter');
        const imageUpload = document.getElementById('image-upload');
        
        // Preview controls
        const narrowBtn = document.getElementById('narrow-btn');
        const widenBtn = document.getElementById('widen-btn');
        const downloadBtn = document.getElementById('download-btn');
        
        // Card width management
        let currentCardWidth = 500; // Initial width in pixels

        // Update preview in real-time
        cardTitleInput.addEventListener('input', () => {
            cardTitle.textContent = cardTitleInput.value || 'Your Card Title';
        });

        watermarkInput.addEventListener('input', () => {
            cardWatermark.textContent = watermarkInput.value || 'Watermark';
        });

        // 修改辅助函数，处理新风格的特殊元素
        function ensureSpecialElements() {
            // 处理新波普风格的特殊元素
            if (previewCard.classList.contains('neopop')) {
                // 添加棋盘格装饰，如果不存在
                let checkerboard = previewCard.querySelector('.checkerboard-decoration');
                if (!checkerboard) {
                    checkerboard = document.createElement('div');
                    checkerboard.className = 'checkerboard-decoration';
                    
                    // 创建三行棋盘格
                    for (let row = 0; row < 3; row++) {
                        const rowDiv = document.createElement('div');
                        rowDiv.className = 'checkerboard-row';
                        
                        // 计算每行需要的方格数量
                        const squaresNeeded = Math.ceil(previewCard.offsetWidth / 15) + 1;
                        
                        // 创建交替的粉色和白色方格
                        for (let i = 0; i < squaresNeeded; i++) {
                            const square = document.createElement('div');
                            square.className = 'checker-square ' + ((row + i) % 2 === 0 ? 'pink' : 'white');
                            rowDiv.appendChild(square);
                        }
                        
                        checkerboard.appendChild(rowDiv);
                    }
                    
                    // 插入到卡片的最前面
                    previewCard.insertBefore(checkerboard, previewCard.firstChild);
                }
                
                // 添加网格背景，如果不存在
                let gridBackground = previewCard.querySelector('.grid-background');
                if (!gridBackground) {
                    gridBackground = document.createElement('div');
                    gridBackground.className = 'grid-background';
                    previewCard.appendChild(gridBackground);
                }
            } else {
                // 如果不是neopop风格，移除棋盘格和网格背景
                const elements = ['.checkerboard-decoration', '.grid-background'];
                elements.forEach(selector => {
                    const el = previewCard.querySelector(selector);
                    if (el) previewCard.removeChild(el);
                });
            }
            
            // 添加蒸汽波风格的特殊元素
            if (previewCard.classList.contains('vaporwave')) {
                // 添加网格背景
                let gridOverlay = previewCard.querySelector('.grid-overlay');
                if (!gridOverlay) {
                    gridOverlay = document.createElement('div');
                    gridOverlay.className = 'grid-overlay';
                    previewCard.appendChild(gridOverlay);
                }
                
                // 添加时间显示
                let digitalTime = previewCard.querySelector('.digital-time');
                if (!digitalTime) {
                    digitalTime = document.createElement('div');
                    digitalTime.className = 'digital-time';
                    digitalTime.textContent = formatTime(new Date());
                    previewCard.appendChild(digitalTime);
                }
                
                // 添加装饰圆形
                let cardDecoration = previewCard.querySelector('.card-decoration');
                if (!cardDecoration) {
                    cardDecoration = document.createElement('div');
                    cardDecoration.className = 'card-decoration';
                    previewCard.appendChild(cardDecoration);
                }
            } else {
                // 如果不是蒸汽波风格，移除相关元素
                const elements = ['.grid-overlay', '.digital-time', '.card-decoration'];
                elements.forEach(selector => {
                    const el = previewCard.querySelector(selector);
                    if (el) previewCard.removeChild(el);
                });
            }
            
            // 添加赛博朋克风格的特殊元素
            if (previewCard.classList.contains('cyberpunk')) {
                // 添加电路线装饰
                let circuitLines = previewCard.querySelector('.circuit-lines');
                if (!circuitLines) {
                    circuitLines = document.createElement('div');
                    circuitLines.className = 'circuit-lines';
                    previewCard.appendChild(circuitLines);
                }
            } else {
                // 如果不是赛博朋克风格，移除相关元素
                const elements = ['.circuit-lines'];
                elements.forEach(selector => {
                    const el = previewCard.querySelector(selector);
                    if (el) previewCard.removeChild(el);
                });
            }
        }

        // 添加一个格式化时间的辅助函数
        function formatTime(date) {
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        // 更新style tabs的click事件监听器
        styleTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs
                styleTabs.forEach(t => t.classList.remove('active'));
                
                // Add active class to clicked tab
                tab.classList.add('active');
                
                // Update card style
                const style = tab.getAttribute('data-style');
                previewCard.className = 'preview-card ' + style;
                
                // 确保特殊元素正确显示
                ensureSpecialElements();
            });
        });

        // 修改下载函数，添加对新风格的支持
        downloadBtn.addEventListener('click', function() {
            // Show loading indicator
            const originalButtonContent = this.innerHTML;
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            
            // 创建一个函数处理下载，避免使用return中断执行
            function processDownload() {
                try {
                    // Create export container
                    const exportContainer = document.createElement('div');
                    exportContainer.style.position = 'fixed';
                    exportContainer.style.top = '-9999px';
                    exportContainer.style.left = '0';
                    exportContainer.style.width = currentCardWidth + 'px';
                    exportContainer.style.height = 'auto';
                    exportContainer.style.backgroundColor = 'transparent';
                    document.body.appendChild(exportContainer);
                    
                    // Create card container
                    const cardContainer = document.createElement('div');
                    cardContainer.style.width = currentCardWidth + 'px';
                    cardContainer.style.padding = '0';
                    cardContainer.style.margin = '0';
                    cardContainer.style.position = 'relative';
                    cardContainer.style.overflow = 'hidden';
                    
                    // 获取所有可能的样式
                    const isMinimalist = previewCard.classList.contains('minimalist');
                    const isHolographic = previewCard.classList.contains('holographic');
                    const isNeopop = previewCard.classList.contains('neopop');
                    const isDarktech = previewCard.classList.contains('darktech');
                    const isCyberpunk = previewCard.classList.contains('cyberpunk');
                    const isVaporwave = previewCard.classList.contains('vaporwave');
                    
                    // 处理卡片样式
                    const currentStyle = previewCard.className.replace('preview-card', '').trim();
                    
                    // 应用基本样式
                    if (isMinimalist) {
                        // 极简风格 - 保持原样
                        cardContainer.style.backgroundColor = '#ffffff';
                        cardContainer.style.boxShadow = '0 10px 20px rgba(0, 0, 0, 0.1)';
                        cardContainer.style.padding = '20px';
                        cardContainer.style.borderRadius = '0'; // 方形卡片
                        cardContainer.style.border = '4px solid #4a6bff'; // 蓝色边框
                        
                        // 添加顶部红色装饰
                        const topBorder = document.createElement('div');
                        topBorder.style.position = 'absolute';
                        topBorder.style.top = '0';
                        topBorder.style.left = '0';
                        topBorder.style.width = '100%';
                        topBorder.style.height = '4px';
                        topBorder.style.backgroundColor = '#ff6b6b'; // 红色顶部装饰
                        topBorder.style.zIndex = '1';
                        cardContainer.appendChild(topBorder);
                    } else if (isHolographic) {
                        // 全息风格
                        cardContainer.style.backgroundColor = '#314659'; // 固定背景色
                        cardContainer.style.borderRadius = '12px';
                        cardContainer.style.padding = '25px';
                        cardContainer.style.boxShadow = '0 10px 20px rgba(0, 0, 0, 0.2)';
                        
                        // 添加彩虹顶部边框
                        const rainbowBorder = document.createElement('div');
                        rainbowBorder.style.position = 'absolute';
                        rainbowBorder.style.top = '0';
                        rainbowBorder.style.left = '0';
                        rainbowBorder.style.width = '100%';
                        rainbowBorder.style.height = '5px';
                        rainbowBorder.style.background = 'linear-gradient(90deg, #ff0000, #ff9900, #ffff00, #33cc33, #3399ff, #9933ff, #ff00ff)';
                        cardContainer.appendChild(rainbowBorder);
                    } else if (isNeopop) {
                        // NEOPOP STYLE - 方形卡片
                        cardContainer.style.backgroundColor = '#fff';
                        cardContainer.style.border = '3px solid #000';
                        cardContainer.style.borderRadius = '0'; // 方形卡片
                        cardContainer.style.padding = '25px';
                        cardContainer.style.boxShadow = '8px 8px 0 #000';
                        cardContainer.style.marginTop = '8px';
                        cardContainer.style.marginLeft = '8px';
                        cardContainer.style.overflow = 'visible'; // 允许内容溢出，显示完整圆形
                        
                        // 明确添加棋盘格装饰 - 重要修改部分
                        const checkerboard = document.createElement('div');
                        checkerboard.style.position = 'absolute';
                        checkerboard.style.top = '0';
                        checkerboard.style.left = '0';
                        checkerboard.style.right = '0';
                        checkerboard.style.height = '45px';
                        checkerboard.style.display = 'flex';
                        checkerboard.style.flexDirection = 'column';
                        checkerboard.style.zIndex = '0';
                        
                        // 创建三行棋盘格
                        for (let row = 0; row < 3; row++) {
                            const rowDiv = document.createElement('div');
                            rowDiv.style.display = 'flex';
                            rowDiv.style.height = '15px';
                            
                            // 计算每行需要的方格数量
                            const squaresNeeded = Math.ceil(currentCardWidth / 15) + 1;
                            
                            // 创建交替的粉色和白色方格
                            for (let i = 0; i < squaresNeeded; i++) {
                                const square = document.createElement('div');
                                square.style.width = '15px';
                                square.style.height = '15px';
                                square.style.flexShrink = '0';
                                
                                if ((row + i) % 2 === 0) {
                                    square.style.backgroundColor = '#FF61D8'; // 粉色
                                } else {
                                    square.style.backgroundColor = 'white';
                                }
                                
                                rowDiv.appendChild(square);
                            }
                            
                            checkerboard.appendChild(rowDiv);
                        }
                        
                        // 将棋盘格添加到卡片（必须放在最前面）
                        cardContainer.insertBefore(checkerboard, cardContainer.firstChild);
                        
                        // 绿色圆点保留，但提高z-index
                        const greenCircle = document.createElement('div');
                        greenCircle.style.position = 'absolute';
                        greenCircle.style.bottom = '60px';
                        greenCircle.style.right = '15px';
                        greenCircle.style.width = '20px';
                        greenCircle.style.height = '20px';
                        greenCircle.style.backgroundColor = '#4BE3AC'; // 绿色
                        greenCircle.style.borderRadius = '50%';
                        greenCircle.style.zIndex = '3'; // 提高z-index至3，确保在内容上方
                        cardContainer.appendChild(greenCircle);
                        
                        // 添加网格背景 - 调整Z索引确保正确显示
                        const gridBackground = document.createElement('div');
                        gridBackground.style.position = 'absolute';
                        gridBackground.style.top = '0';
                        gridBackground.style.left = '0';
                        gridBackground.style.right = '0';
                        gridBackground.style.bottom = '0';
                        gridBackground.style.backgroundImage = 
                            'linear-gradient(90deg, rgba(0, 0, 0, 0.1) 1px, transparent 1px), ' +
                            'linear-gradient(rgba(0, 0, 0, 0.1) 1px, transparent 1px)';
                        gridBackground.style.backgroundSize = '15px 15px';
                        gridBackground.style.zIndex = '0';
                        gridBackground.style.pointerEvents = 'none';
                        cardContainer.appendChild(gridBackground);
                    } else if (isDarktech) {
                        // 暗黑科技风格
                        cardContainer.style.backgroundColor = '#0a0a0a';
                        cardContainer.style.border = '1px solid #30cfd0';
                        cardContainer.style.borderRadius = '8px';
                        cardContainer.style.padding = '25px';
                        cardContainer.style.boxShadow = '0 0 15px rgba(48, 207, 208, 0.5)';
                        
                        // 添加网格背景
                        const gridOverlay = document.createElement('div');
                        gridOverlay.style.position = 'absolute';
                        gridOverlay.style.top = '0';
                        gridOverlay.style.left = '0';
                        gridOverlay.style.right = '0';
                        gridOverlay.style.bottom = '0';
                        gridOverlay.style.backgroundImage = 
                            'linear-gradient(90deg, rgba(48, 207, 208, 0.1) 1px, transparent 1px), ' +
                            'linear-gradient(rgba(48, 207, 208, 0.1) 1px, transparent 1px)';
                        gridOverlay.style.backgroundSize = '22px 22px';
                        gridOverlay.style.zIndex = '0';
                        cardContainer.appendChild(gridOverlay);
                    } else if (isCyberpunk) {
                        // 赛博朋克风格 - 增强发光效果
                        
                        // 创建发光外层容器
                        const glowContainer = document.createElement('div');
                        glowContainer.style.position = 'absolute';
                        glowContainer.style.top = '0';
                        glowContainer.style.left = '0';
                        glowContainer.style.right = '0';
                        glowContainer.style.bottom = '0';
                        glowContainer.style.padding = '8px'; // 为发光效果留出空间
                        glowContainer.style.borderRadius = '12px';
                        glowContainer.style.backgroundColor = 'transparent';
                        glowContainer.style.zIndex = '0';
                        
                        // 创建第一层发光效果
                        const outerGlow = document.createElement('div');
                        outerGlow.style.position = 'absolute';
                        outerGlow.style.top = '0';
                        outerGlow.style.left = '0';
                        outerGlow.style.right = '0';
                        outerGlow.style.bottom = '0';
                        outerGlow.style.border = '4px solid rgba(255, 0, 255, 0.5)';
                        outerGlow.style.borderRadius = '9px';
                        outerGlow.style.filter = 'blur(3px)';
                        outerGlow.style.zIndex = '0';
                        glowContainer.appendChild(outerGlow);
                        
                        // 创建第二层发光效果
                        const innerGlow = document.createElement('div');
                        innerGlow.style.position = 'absolute';
                        innerGlow.style.top = '4px';
                        innerGlow.style.left = '4px';
                        innerGlow.style.right = '4px';
                        innerGlow.style.bottom = '4px';
                        innerGlow.style.border = '2px solid rgba(0, 255, 252, 0.8)';
                        innerGlow.style.borderRadius = '7px';
                        innerGlow.style.filter = 'blur(2px)';
                        innerGlow.style.zIndex = '0';
                        glowContainer.appendChild(innerGlow);
                        
                        // 添加发光容器到主容器
                        cardContainer.appendChild(glowContainer);
                        
                        // 设置主卡片容器样式
                        cardContainer.style.background = 'linear-gradient(135deg, #0b0b2a 0%, #1a1a3a 100%)';
                        cardContainer.style.color = '#00fffc';
                        cardContainer.style.border = '1px solid #ff00ff';
                        cardContainer.style.borderRadius = '5px';
                        cardContainer.style.padding = '25px';
                        cardContainer.style.position = 'relative';
                        cardContainer.style.overflow = 'hidden';
                        cardContainer.style.zIndex = '1';
                        
                        // 添加网格背景
                        const gridOverlay = document.createElement('div');
                        gridOverlay.style.position = 'absolute';
                        gridOverlay.style.top = '0';
                        gridOverlay.style.left = '0';
                        gridOverlay.style.right = '0';
                        gridOverlay.style.bottom = '0';
                        gridOverlay.style.backgroundImage = 
                            'linear-gradient(rgba(255, 0, 255, 0.1) 1px, transparent 1px), ' +
                            'linear-gradient(90deg, rgba(255, 0, 255, 0.1) 1px, transparent 1px)';
                        gridOverlay.style.backgroundSize = '20px 20px';
                        gridOverlay.style.pointerEvents = 'none';
                        gridOverlay.style.zIndex = '0';
                        cardContainer.appendChild(gridOverlay);
                        
                        // 添加电路线装饰
                        const circuitLines = document.createElement('div');
                        circuitLines.style.position = 'absolute';
                        circuitLines.style.bottom = '20px';
                        circuitLines.style.left = '20px';
                        circuitLines.style.width = '100px';
                        circuitLines.style.height = '50px';
                        circuitLines.style.borderBottom = '2px solid #00fffc';
                        circuitLines.style.borderLeft = '2px solid #00fffc';
                        circuitLines.style.zIndex = '0';
                        circuitLines.style.opacity = '0.7';
                        cardContainer.appendChild(circuitLines);
                        
                        // 添加标题
                        const titleElement = document.createElement('div');
                        titleElement.style.color = '#ff00ff';
                        titleElement.style.textShadow = '0 0 10px #ff00ff';
                        titleElement.style.fontFamily = 'Arial, sans-serif';
                        titleElement.style.fontWeight = '700';
                        titleElement.style.position = 'relative';
                        titleElement.style.zIndex = '1';
                        titleElement.style.borderLeft = '3px solid #00fffc';
                        titleElement.style.paddingLeft = '15px';
                        titleElement.style.marginBottom = '25px';
                        titleElement.style.fontSize = '1.5rem';
                        titleElement.innerHTML = cardTitle.innerHTML;
                        cardContainer.appendChild(titleElement);
                        
                        // 添加内容
                        const contentElement = document.createElement('div');
                        contentElement.style.backgroundColor = 'rgba(10, 10, 43, 0.7)';
                        contentElement.style.border = '1px solid #00fffc';
                        contentElement.style.borderRadius = '5px';
                        contentElement.style.padding = '20px';
                        contentElement.style.color = '#00fffc';
                        contentElement.style.textShadow = '0 0 5px rgba(0, 255, 252, 0.7)';
                        contentElement.style.position = 'relative';
                        contentElement.style.zIndex = '1';
                        contentElement.style.boxShadow = '0 0 10px rgba(0, 255, 252, 0.3)';
                        contentElement.innerHTML = cardContent.innerHTML;
                        cardContainer.appendChild(contentElement);
                        
                        // 添加水印
                        const watermarkElement = document.createElement('div');
                        watermarkElement.style.position = 'absolute';
                        watermarkElement.style.bottom = '10px';
                        watermarkElement.style.right = '10px';
                        watermarkElement.style.fontSize = '0.8rem';
                        watermarkElement.style.opacity = '0.7';
                        watermarkElement.style.zIndex = '2';
                        watermarkElement.style.color = '#ff00ff';
                        watermarkElement.style.textShadow = '0 0 5px #ff00ff';
                        watermarkElement.innerHTML = cardWatermark.innerHTML;
                        cardContainer.appendChild(watermarkElement);
                    } else if (isVaporwave) {
                        // 蒸汽波风格
                        cardContainer.style.background = 'linear-gradient(to bottom, #c774e8 0%, #94a6fe 100%)';
                        cardContainer.style.color = 'white';
                        cardContainer.style.border = '4px solid #0ff';
                        cardContainer.style.borderRadius = '0';
                        cardContainer.style.boxShadow = '0 0 0 2px #ff71ce, 0 0 25px rgba(0, 255, 255, 0.5)';
                        cardContainer.style.position = 'relative';
                        cardContainer.style.overflow = 'hidden';
                        cardContainer.style.padding = '25px';
                        
                        // 添加上边缘渐变条
                        const topGradient = document.createElement('div');
                        topGradient.style.position = 'absolute';
                        topGradient.style.top = '0';
                        topGradient.style.left = '0';
                        topGradient.style.right = '0';
                        topGradient.style.height = '8px';
                        topGradient.style.background = 'linear-gradient(90deg, transparent 0%, #0ff 10%, #ff71ce 30%, transparent 40%, #0ff 60%, #ff71ce 80%, transparent 100%)';
                        topGradient.style.zIndex = '1';
                        cardContainer.appendChild(topGradient);
                        
                        // 添加下边缘渐变条
                        const bottomGradient = document.createElement('div');
                        bottomGradient.style.position = 'absolute';
                        bottomGradient.style.bottom = '0';
                        bottomGradient.style.left = '0';
                        bottomGradient.style.right = '0';
                        bottomGradient.style.height = '8px';
                        bottomGradient.style.background = 'linear-gradient(90deg, transparent 0%, #0ff 10%, #ff71ce 30%, transparent 40%, #0ff 60%, #ff71ce 80%, transparent 100%)';
                        bottomGradient.style.zIndex = '1';
                        cardContainer.appendChild(bottomGradient);
                        
                        // 添加网格背景
                        const gridOverlay = document.createElement('div');
                        gridOverlay.style.position = 'absolute';
                        gridOverlay.style.top = '0';
                        gridOverlay.style.left = '0';
                        gridOverlay.style.right = '0';
                        gridOverlay.style.bottom = '0';
                        gridOverlay.style.backgroundImage = 
                            'linear-gradient(rgba(255, 255, 255, 0.1) 1px, transparent 1px), ' +
                            'linear-gradient(90deg, rgba(255, 255, 255, 0.1) 1px, transparent 1px)';
                        gridOverlay.style.backgroundSize = '20px 20px';
                        gridOverlay.style.pointerEvents = 'none';
                        gridOverlay.style.zIndex = '0';
                        cardContainer.appendChild(gridOverlay);
                        
                        // 添加数字时间显示
                        const digitalTime = document.createElement('div');
                        digitalTime.style.position = 'absolute';
                        digitalTime.style.top = '15px';
                        digitalTime.style.right = '15px';
                        digitalTime.style.fontFamily = 'Courier New, monospace';
                        digitalTime.style.fontSize = '1rem';
                        digitalTime.style.color = '#fff';
                        digitalTime.style.background = 'rgba(1, 205, 254, 0.2)';
                        digitalTime.style.padding = '5px 10px';
                        digitalTime.style.border = '1px solid #01cdfe';
                        digitalTime.style.zIndex = '2';
                        digitalTime.textContent = formatTime(new Date());
                        cardContainer.appendChild(digitalTime);
                        
                        // 添加装饰圆形
                        const cardDecoration = document.createElement('div');
                        cardDecoration.style.position = 'absolute';
                        cardDecoration.style.bottom = '60px';
                        cardDecoration.style.right = '25px';
                        cardDecoration.style.width = '80px';
                        cardDecoration.style.height = '80px';
                        cardDecoration.style.borderRadius = '50%';
                        cardDecoration.style.background = 'linear-gradient(45deg, #ff71ce, #ff71ce 50%, #01cdfe 50%, #01cdfe)';
                        cardDecoration.style.zIndex = '1';
                        cardDecoration.style.boxShadow = '0 0 15px rgba(1, 205, 254, 0.5)';
                        cardContainer.appendChild(cardDecoration);
                        
                        // 添加标题
                        const titleElement = document.createElement('div');
                        titleElement.style.color = 'white';
                        titleElement.style.fontSize = '2rem';
                        titleElement.style.fontWeight = 'bold';
                        titleElement.style.textShadow = '3px 3px 0 #ff71ce, 6px 6px 0 #01cdfe';
                        titleElement.style.letterSpacing = '2px';
                        titleElement.style.marginBottom = '25px';
                        titleElement.style.textTransform = 'uppercase';
                        titleElement.style.position = 'relative';
                        titleElement.style.zIndex = '2';
                        titleElement.innerHTML = cardTitle.innerHTML.toUpperCase(); // 转为大写
                        cardContainer.appendChild(titleElement);
                        
                        // 添加内容
                        const contentElement = document.createElement('div');
                        contentElement.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
                        contentElement.style.border = '2px solid #01cdfe';
                        contentElement.style.padding = '20px';
                        contentElement.style.position = 'relative';
                        contentElement.style.textShadow = '1px 1px 0 #01cdfe';
                        contentElement.style.zIndex = '2';
                        contentElement.style.marginBottom = '20px';
                        contentElement.innerHTML = cardContent.innerHTML;
                        cardContainer.appendChild(contentElement);
                        
                        // 添加水印
                        const watermarkElement = document.createElement('div');
                        watermarkElement.style.position = 'absolute';
                        watermarkElement.style.bottom = '10px';
                        watermarkElement.style.right = '10px';
                        watermarkElement.style.fontSize = '0.8rem';
                        watermarkElement.style.opacity = '0.7';
                        watermarkElement.style.zIndex = '2';
                        watermarkElement.style.color = '#fff';
                        watermarkElement.style.textShadow = '2px 2px 0 #ff71ce';
                        watermarkElement.style.fontStyle = 'italic';
                        watermarkElement.innerHTML = cardWatermark.innerHTML;
                        cardContainer.appendChild(watermarkElement);
                    }
                    
                    // 除了赛博朋克和蒸汽波风格外，其他风格需要添加内容元素
                    if (!isCyberpunk && !isVaporwave) {
                        // 添加标题
                        const titleElement = document.createElement('div');
                        titleElement.style.fontSize = '1.5rem';
                        titleElement.style.fontWeight = 'bold';
                        titleElement.style.marginBottom = '15px';
                        titleElement.style.position = 'relative';
                        titleElement.style.zIndex = '2';
                        
                        // 根据不同风格应用不同的标题样式
                        if (isMinimalist) {
                            titleElement.style.color = '#333';
                        } else if (isHolographic) {
                            titleElement.style.color = 'white';
                            titleElement.style.textShadow = '0 2px 4px rgba(0,0,0,0.3)';
                            titleElement.style.marginBottom = '20px';
                        } else if (isNeopop) {
                            titleElement.style.position = 'relative';
                            titleElement.style.zIndex = '2';
                            titleElement.style.color = '#000';
                            titleElement.style.fontWeight = '800';
                            titleElement.style.marginBottom = '20px';
                            titleElement.style.fontSize = '1.8rem';
                            titleElement.style.padding = '5px 10px';
                            titleElement.style.backgroundColor = '#56CCF2';
                            titleElement.style.display = 'inline-block';
                            titleElement.style.border = '3px solid #000';
                        } else if (isDarktech) {
                            titleElement.style.color = '#30cfd0';
                            titleElement.style.fontWeight = '600';
                            titleElement.style.marginBottom = '25px';
                            titleElement.style.textShadow = '0 0 10px rgba(48, 207, 208, 0.7)';
                            titleElement.style.fontFamily = 'Courier New, monospace';
                            titleElement.style.paddingLeft = '15px';
                            titleElement.style.borderLeft = '3px solid #30cfd0';
                        }
                        
                        titleElement.innerHTML = cardTitle.innerHTML;
                        cardContainer.appendChild(titleElement);
                        
                        // 添加内容
                            const contentElement = document.createElement('div');
                            contentElement.style.marginBottom = '20px';
                            contentElement.style.position = 'relative';
                            contentElement.style.zIndex = '2';
                        
                        // 根据不同风格应用不同的内容样式
                        if (isMinimalist) {
                            contentElement.style.color = '#555';
                        } else if (isHolographic) {
                            contentElement.style.backgroundColor = 'rgba(255, 255, 255, 0.75)';
                            contentElement.style.borderRadius = '8px';
                            contentElement.style.padding = '20px';
                            contentElement.style.margin = '15px 0';
                            contentElement.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
                            contentElement.style.border = '2px solid #9933ff';
                        } else if (isNeopop) {
                            contentElement.style.backgroundColor = '#FBD348';
                            contentElement.style.border = '3px solid #000';
                            contentElement.style.padding = '20px';
                            contentElement.style.margin = '20px 0 30px';
                            contentElement.style.boxShadow = '5px 5px 0 #000';
                            contentElement.style.position = 'relative';
                            contentElement.style.zIndex = '1';
                        } else if (isDarktech) {
                            contentElement.style.backgroundColor = 'rgba(10, 10, 10, 0.8)';
                            contentElement.style.border = '1px solid #30cfd0';
                            contentElement.style.borderRadius = '5px';
                            contentElement.style.padding = '20px';
                            contentElement.style.margin = '10px 0 20px';
                            contentElement.style.color = '#ffffff';
                            contentElement.style.fontFamily = 'Courier New, monospace';
                            contentElement.style.boxShadow = '0 0 10px rgba(48, 207, 208, 0.3)';
                        }
                        
                            contentElement.innerHTML = cardContent.innerHTML;
                            cardContainer.appendChild(contentElement);
                        
                        // 添加水印
                        const watermarkElement = document.createElement('div');
                        watermarkElement.style.position = 'absolute';
                        watermarkElement.style.bottom = '10px';
                        watermarkElement.style.right = '10px';
                        watermarkElement.style.fontSize = '0.8rem';
                        watermarkElement.style.opacity = '0.5';
                        watermarkElement.style.fontStyle = 'italic';
                        watermarkElement.style.zIndex = '2';
                        
                        // 根据不同风格应用不同的水印样式
                        if (isMinimalist) {
                            watermarkElement.style.color = '#888';
                        } else if (isHolographic) {
                            watermarkElement.style.color = 'rgba(255, 255, 255, 0.7)';
                        } else if (isNeopop) {
                            watermarkElement.style.color = '#555';
                            watermarkElement.style.fontWeight = 'bold';
                        } else if (isDarktech) {
                            watermarkElement.style.color = '#30cfd0';
                            watermarkElement.style.fontFamily = 'Courier New, monospace';
                        }
                        
                        watermarkElement.innerHTML = cardWatermark.innerHTML;
                        cardContainer.appendChild(watermarkElement);
                        
                        // 如果是新波普风格，创建和添加圆形装饰
                        if (isNeopop) {
                            // 添加左上圆形装饰 - 与CSS .card-content::before对应
                        const topCircle = document.createElement('div');
                        topCircle.style.position = 'absolute';
                        topCircle.style.left = '15px';
                            topCircle.style.top = contentElement.offsetTop - 15 + 'px'; // 动态计算，根据内容区位置
                        topCircle.style.width = '30px';
                        topCircle.style.height = '30px';
                            topCircle.style.backgroundColor = '#ff6b6b'; // 粉色
                        topCircle.style.border = '3px solid #000';
                        topCircle.style.borderRadius = '50%';
                            topCircle.style.zIndex = '3';
                        
                            // 添加右下圆形装饰 - 与CSS .card-content::after对应
                        const bottomCircle = document.createElement('div');
                        bottomCircle.style.position = 'absolute';
                        bottomCircle.style.right = '15px';
                            bottomCircle.style.bottom = contentElement.offsetTop + contentElement.offsetHeight - 15 + 'px'; // 动态计算
                        bottomCircle.style.width = '30px';
                        bottomCircle.style.height = '30px';
                            bottomCircle.style.backgroundColor = '#4a6bff'; // 蓝色
                        bottomCircle.style.border = '3px solid #000';
                        bottomCircle.style.borderRadius = '50%';
                            bottomCircle.style.zIndex = '3';
                            
                            // 延迟添加圆形，确保内容区位置已经计算
                            setTimeout(() => {
                                cardContainer.appendChild(topCircle);
                                cardContainer.appendChild(bottomCircle);
                            }, 50);
                        }
                    }
                    
                    // 添加卡片到导出容器
                    exportContainer.appendChild(cardContainer);
                    
                    // 处理渲染和下载
                    setTimeout(() => {
                        const cardHeight = cardContainer.offsetHeight;
                        exportContainer.style.height = (cardHeight + 10) + 'px';
                        
                        // 配置html2canvas选项
                        let options = {
                            scale: 2,
                            logging: true,
                            useCORS: true,
                            allowTaint: true,
                            backgroundColor: null,
                            onclone: function(clonedDoc) {
                                // 确保克隆的元素样式正确
                                const clonedCard = clonedDoc.querySelector('div');
                                if (clonedCard) {
                                    clonedCard.style.margin = '0';
                                    
                                    // 特别处理新波普风格
                                    if (isNeopop) {
                                        clonedCard.style.borderRadius = '0'; // 确保方形
                                        clonedCard.style.overflow = 'visible'; // 允许圆形显示
                                        
                                        // 确保网格背景正确显示
                                        const gridBg = clonedCard.querySelector('.grid-background');
                                        if (gridBg) {
                                            gridBg.style.backgroundImage = 
                                                'linear-gradient(90deg, rgba(0, 0, 0, 0.1) 1px, transparent 1px), ' +
                                                'linear-gradient(rgba(0, 0, 0, 0.1) 1px, transparent 1px)';
                                            gridBg.style.backgroundSize = '15px 15px';
                                        }
                                    }
                                }
                            }
                        };
                        
                        // 修改特定风格的背景色设置
                        if (isMinimalist || isNeopop) {
                            options.backgroundColor = '#ffffff';
                        } else if (isCyberpunk) {
                            // 确保赛博朋克的深色背景正确渲染
                            options.backgroundColor = '#0b0b2a';
                        } else if (isVaporwave) {
                            // 确保蒸汽波的渐变背景能够正确捕获
                            options.backgroundColor = null;
                        }
                        
                        html2canvas(cardContainer, options).then(canvas => {
                            try {
                                const imgData = canvas.toDataURL('image/png');
                                const link = document.createElement('a');
                                link.href = imgData;
                                const fileName = cardTitle.textContent.replace(/\s+/g, '-').toLowerCase() || 'knowledge-card';
                                link.download = fileName + '-card.png';
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                            } catch (e) {
                                console.error('Error creating download link:', e);
                                alert('Error creating download link. Please try again.');
                            }
                            
                            document.body.removeChild(exportContainer);
                            downloadBtn.disabled = false;
                            downloadBtn.innerHTML = originalButtonContent;
                        }).catch(error => {
                            console.error('html2canvas error:', error);
                            alert('Failed to generate image. Error: ' + error.message);
                            document.body.removeChild(exportContainer);
                            downloadBtn.disabled = false;
                            downloadBtn.innerHTML = originalButtonContent;
                        });
                    }, 200);
                } catch (error) {
                    console.error('Unexpected error in card export:', error);
                    alert('An unexpected error occurred: ' + error.message);
                    downloadBtn.disabled = false;
                    downloadBtn.innerHTML = originalButtonContent;
                }
            }
            
            // 执行下载处理
            processDownload();
        });

        // Format painter functionality
        let formatData = null;
        let formatPainterActive = false;

        formatPainter.addEventListener('click', () => {
            const selection = window.getSelection();
            
            if (selection.rangeCount > 0 && !formatPainterActive) {
                // Copy format
                const range = selection.getRangeAt(0);
                if (!range.collapsed) {
                    const selectedNode = range.commonAncestorContainer;
                    
                    // Get the parent element if we're in a text node
                    const selectedElement = selectedNode.nodeType === 3 ? selectedNode.parentNode : selectedNode;
                    
                    // Store format data
                    formatData = {
                        fontWeight: getComputedStyle(selectedElement).fontWeight,
                        fontStyle: getComputedStyle(selectedElement).fontStyle,
                        textDecoration: getComputedStyle(selectedElement).textDecoration,
                        fontSize: getComputedStyle(selectedElement).fontSize,
                        color: getComputedStyle(selectedElement).color,
                        backgroundColor: getComputedStyle(selectedElement).backgroundColor,
                        textAlign: getComputedStyle(selectedElement).textAlign,
                        html: selectedElement.outerHTML
                    };
                    
                    // Activate format painter
                    formatPainterActive = true;
                    formatPainter.classList.add('active');
                    formatPainter.querySelector('i').classList.remove('fa-paint-brush');
                    formatPainter.querySelector('i').classList.add('fa-check');
                } else {
                    alert('Please select some text to copy its format');
                }
            } else if (formatPainterActive) {
                // Cancel format painter
                formatPainterActive = false;
                formatPainter.classList.remove('active');
                formatPainter.querySelector('i').classList.remove('fa-check');
                formatPainter.querySelector('i').classList.add('fa-paint-brush');
            }
        });

        // Apply format when text is selected while format painter is active
        editor.addEventListener('mouseup', () => {
            if (formatPainterActive) {
                const selection = window.getSelection();
                
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    
                    if (!range.collapsed) {
                        // Apply format to selected text
                        const selectedContent = range.extractContents();
                        const span = document.createElement('span');
                        
                        // Apply stored styles
                        span.style.fontWeight = formatData.fontWeight;
                        span.style.fontStyle = formatData.fontStyle;
                        span.style.textDecoration = formatData.textDecoration;
                        span.style.fontSize = formatData.fontSize;
                        span.style.color = formatData.color;
                        
                        if (formatData.backgroundColor !== 'rgba(0, 0, 0, 0)' && 
                            formatData.backgroundColor !== 'transparent') {
                            span.style.backgroundColor = formatData.backgroundColor;
                        }
                        
                        span.style.textAlign = formatData.textAlign;
                        
                        span.appendChild(selectedContent);
                        range.insertNode(span);
                        
                        // Deactivate format painter after one use
                        formatPainterActive = false;
                        formatPainter.classList.remove('active');
                        formatPainter.querySelector('i').classList.remove('fa-check');
                        formatPainter.querySelector('i').classList.add('fa-paint-brush');
                        
                        // Update preview
                        const inputEvent = new Event('input', {
                            bubbles: true,
                            cancelable: true,
                        });
                        editor.dispatchEvent(inputEvent);
                    }
                }
            }
        });

        // Fixed image upload to properly insert at cursor position
        imageUpload.addEventListener('change', function() {
            const file = this.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                // Create image element
                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.maxWidth = '100%';
                img.style.height = 'auto';
                img.style.display = 'block';
                img.style.margin = '10px auto';
                
                // Save current selection
                const selection = window.getSelection();
                const range = selection.getRangeAt(0);
                
                // Insert a line break if needed
                const container = range.commonAncestorContainer;
                const isAtEnd = container.nodeType === Node.TEXT_NODE ? 
                    range.startOffset === container.textContent.length : 
                    range.startOffset === container.childNodes.length;
                
                // Insert the image at the cursor position
                if (container === editor || editor.contains(container)) {
                    // Insert line break before image if not at beginning of line
                    if (!isAtEnd && container.nodeType === Node.TEXT_NODE && range.startOffset > 0) {
                        const br = document.createElement('br');
                        range.insertNode(br);
                        range.setStartAfter(br);
                    }
                    
                    // Insert the image
                    range.insertNode(img);
                    
                    // Move cursor after the image
                    range.setStartAfter(img);
                    
                    // Insert line break after image
                    const brAfter = document.createElement('br');
                    range.insertNode(brAfter);
                    range.setStartAfter(brAfter);
                    
                    // Update selection
                    selection.removeAllRanges();
                    selection.addRange(range);
                } else {
                    // Fallback: append to the end if selection is outside editor
                    editor.appendChild(document.createElement('br'));
                    editor.appendChild(img);
                    editor.appendChild(document.createElement('br'));
                }
                
                // Update preview
                cardContent.innerHTML = editor.innerHTML;
            };
            
            reader.readAsDataURL(file);
            
            // Reset file input to allow selecting the same file again
            this.value = '';
        });

        // Ensure editor always has focus when clicking on toolbar buttons
        document.querySelectorAll('.toolbar button').forEach(button => {
            button.addEventListener('mousedown', (e) => {
                // Prevent default to avoid losing focus from editor
                e.preventDefault();
            });
        });

        // Initialize with default values
        cardTitleInput.value = 'Your Card Title';
        watermarkInput.value = 'Watermark';
        editor.innerHTML = '<p>Start editing to see your content here...</p>';
        cardContent.innerHTML = editor.innerHTML;
        
        // Ensure editor has focus when page loads
        window.addEventListener('load', () => {
            // Set initial focus to editor
            setTimeout(() => {
                editor.focus();
                
                // Place cursor at the end of the content
                const range = document.createRange();
                const sel = window.getSelection();
                range.selectNodeContents(editor);
                range.collapse(false); // false means collapse to end
                sel.removeAllRanges();
                sel.addRange(range);
            }, 100);
            
            // 如果默认是新波普风格，调用增强后的函数确保显示棋盘格
            ensureSpecialElements();
        });

        // 在编辑器内容变更后调用此函数
        editor.addEventListener('input', () => {
            cardContent.innerHTML = editor.innerHTML;
            
            // 确保特殊元素正确显示
            ensureSpecialElements();
        });

        // 文本格式化按钮事件监听器
        boldBtn.addEventListener('click', () => {
            editor.focus();
            document.execCommand('bold', false, null);
        });

        italicBtn.addEventListener('click', () => {
            editor.focus();
            document.execCommand('italic', false, null);
        });

        underlineBtn.addEventListener('click', () => {
            editor.focus();
            document.execCommand('underline', false, null);
        });

        // 字体大小选择器
        fontSizeSelect.addEventListener('change', () => {
            editor.focus();
            document.execCommand('fontSize', false, fontSizeSelect.value);
        });

        // 文本颜色选择器 - 增加点击事件
        textColor.addEventListener('click', (e) => {
            // 如果是input元素的正常点击，不执行额外操作(让浏览器正常打开颜色选择器)
            // 但如果点击事件被阻止默认行为，则表示这是复用颜色的点击操作
            if (e.target === textColor && e.defaultPrevented) {
                return;
            }
            
            // 获取选中的文本并应用当前颜色
            editor.focus();
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                if (!range.collapsed) {
                    // 应用当前颜色值
                    document.execCommand('foreColor', false, textColor.value);
                    // 防止颜色选择器对话框打开
                    e.preventDefault();
                }
            }
        });

        // 背景颜色选择器 - 增加点击事件
        bgColor.addEventListener('click', (e) => {
            // 同样的逻辑判断
            if (e.target === bgColor && e.defaultPrevented) {
                return;
            }
            
            // 获取选中的文本并应用当前背景色
            editor.focus();
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                if (!range.collapsed) {
                    // 应用当前背景色值
                    document.execCommand('hiliteColor', false, bgColor.value);
                    // 防止颜色选择器对话框打开
                    e.preventDefault();
                }
            }
        });

        // 文本对齐按钮
        alignLeft.addEventListener('click', () => {
            editor.focus();
            document.execCommand('justifyLeft', false, null);
        });

        alignCenter.addEventListener('click', () => {
            editor.focus();
            document.execCommand('justifyCenter', false, null);
        });

        alignRight.addEventListener('click', () => {
            editor.focus();
            document.execCommand('justifyRight', false, null);
        });

        // 添加选择状态更新，使按钮状态与当前格式保持同步
        editor.addEventListener('mouseup', updateToolbarState);
        editor.addEventListener('keyup', updateToolbarState);

        // 更新工具栏状态函数
        function updateToolbarState() {
            boldBtn.classList.toggle('active', document.queryCommandState('bold'));
            italicBtn.classList.toggle('active', document.queryCommandState('italic'));
            underlineBtn.classList.toggle('active', document.queryCommandState('underline'));
            alignLeft.classList.toggle('active', document.queryCommandState('justifyLeft'));
            alignCenter.classList.toggle('active', document.queryCommandState('justifyCenter'));
            alignRight.classList.toggle('active', document.queryCommandState('justifyRight'));
        }

        // 在elements部分添加新按钮变量
        const clearFormatBtn = document.getElementById('clear-format-btn');

        // 在现有的格式化按钮事件监听器部分添加清除格式功能
        clearFormatBtn.addEventListener('click', () => {
            editor.focus();
            // 移除所有格式
            document.execCommand('removeFormat', false, null);
            
            // 恢复为当前风格的默认颜色和字体
            const currentStyle = previewCard.className.replace('preview-card', '').trim();
            
            // 获取选中的文本范围
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                if (!range.collapsed) {
                    // 获取根据当前卡片风格的默认样式
                    let defaultColor, defaultBgColor;
                    
                    if (currentStyle === 'minimalist') {
                        defaultColor = '#555';
                        defaultBgColor = 'transparent';
                    } else if (currentStyle === 'holographic') {
                        defaultColor = '#000';
                        defaultBgColor = 'rgba(255, 255, 255, 0.75)';
                    } else if (currentStyle === 'neopop') {
                        defaultColor = '#000';
                        defaultBgColor = '#FBD348';
                    } else if (currentStyle === 'darktech') {
                        defaultColor = '#ffffff';
                        defaultBgColor = 'rgba(10, 10, 10, 0.8)';
                    } else if (currentStyle === 'cyberpunk') {
                        defaultColor = '#00fffc';
                        defaultBgColor = 'rgba(10, 10, 43, 0.7)';
                    } else if (currentStyle === 'vaporwave') {
                        defaultColor = '#fff';
                        defaultBgColor = 'rgba(255, 255, 255, 0.2)';
                    }
                    
                    // 应用默认颜色
                    document.execCommand('foreColor', false, defaultColor);
                    
                    // 根据需要应用默认背景色
                    if (defaultBgColor !== 'transparent') {
                        document.execCommand('hiliteColor', false, defaultBgColor);
                    }
                }
            }
            
            // 更新预览
            cardContent.innerHTML = editor.innerHTML;
            
            // 更新工具栏状态
            updateToolbarState();
        });

        // 添加宽度调整功能的事件监听器
        // 放在初始化部分，"Card width management"之后
        narrowBtn.addEventListener('click', () => {
            if (currentCardWidth > 300) {
                currentCardWidth -= 50;
                updateCardWidth();
            }
        });

        widenBtn.addEventListener('click', () => {
            if (currentCardWidth < 800) {
                currentCardWidth += 50;
                updateCardWidth();
            }
        });

        // 更新卡片宽度的辅助函数
        function updateCardWidth() {
            previewCard.style.maxWidth = currentCardWidth + 'px';
            cardWidthDisplay.textContent = currentCardWidth;
        }
    </script>
</body>
</html>
